/*! Banana-fe 0.0.1 */
var cocos=angular.module("cocos",["ngResource","ngRoute","cocos.index","progress","navlist"]);angular.module("navlist",[]).service("navlist",function(){function current(){var pathname=location.pathname,classname="";return classname="/allticket"==pathname?"allticket":classname,classname="/team"==pathname?"team":classname}function reset(){var nlist=[].slice.call(document.querySelectorAll(".menu"),0);nlist.map(function(x){x.classList.remove("current")})}return function(){var classname=current();reset(),classname&&document.querySelector(".menu."+classname).classList.add("current")}}),angular.module("progress",[]).service("ngProgress",function(){var el=document.getElementById("progress"),w=window.innerWidth,start=0,state="uncomplete",time=100,run=function(){start+=25,"uncomplete"==state&&time++,"completed"==state&&(time=1),el.style.width=start+"px",w>start?setTimeout(run,10):(el.style.width="0px",start=0,time=100,state="uncomplete")};return{start:function(){state="uncomplete",run()},complete:function(){state="completed"}}}),angular.module("cocos.index",[]),angular.module("cocos.index").controller("ticketsController",function($scope,$http){$http.get("/tickets/").success(function(data){$scope.tickets=data}),$scope.type={"2dx":"Cocos2d x","2djs":"Cocos2d JS","2dlua":"Cocos2d lua","2dstudio":"Cocos2d Studio","2dcode":"Cocos2d Code IDE",anysdk:"AnySDK",other:"其他"};var ctype="all";$scope[ctype]="current",$scope.tab=function(type){$scope[ctype]="",$scope[type]="current",ctype=type}}),angular.module("cocos.index").controller("indexRouteController",function($scope){$scope.dialog=!1,$scope.type="normal",$scope.showdialog=function(){$scope.dialog=!0}}),angular.module("cocos.index").controller("indexpageController",function($scope,$http){$scope.register=!0,$scope.email="",$scope.submit=function(){var data={};data.email=$scope.email,data.company=$scope.company,$http.post("/signup",data,csrfconfig).success(function(data){return 1==data.status?alert(data.msg):(UserCenter.userinfo=data,localStorage.email=$scope.email,void($scope.register=!1))})}}),angular.module("cocos.index").controller("introController",function($scope,$http){new Swiper(".swiper-container");$scope.signin=function(){$http.post("/signin",{email:$scope.email,password:$scope.password},csrfconfig).success(function(data){data.status?alert(data.msg):location.href="/allticket"})}}),angular.module("cocos.index").controller("newticketController",function($scope,$http){var editor=CodeMirror.fromTextArea(document.getElementById("code"),{lineNumbers:!0,styleActiveLine:!0,matchBrackets:!0,mode:"javascript"});console.log(editor),$scope.selectx="2dx",$scope.select=function(item){$scope.selected[$scope.selectx]="",$scope.selectx=item,$scope.selected[item]="selected"},$scope.selected={"2dx":"selected","2djs":"","2dlua":"","2dstudio":"","2dcode":"",anysdk:"",other:""},$scope.ticket="offical",$scope.newticket=function(){var data={};return data.title=$scope.xtitle,data.content=editor.getValue(),data.type=$scope.selectx,data.ticket=$scope.ticket,0==data.title.length?alert("请添加标题"):void $http.post("/ticket",data,csrfconfig).success(function(data){location.href="/chat#"+data[0]._id})}}),angular.module("cocos.index").controller("ticketController",function($scope,$http,$route){function reader(){var reader=new FileReader,file=this.files[0];reader.onloadend=function(){var base64=reader.result;$http.post("/uploadfile",{base64:base64},csrfconfig).success(function(data){$scope.tips="图片已选择："+data.id,$scope.image=data.id}).error(function(){alert("图片太大")})},reader.readAsDataURL(file)}var tid=$route.current.params.id;$http.get("/ticket/data/"+tid).success(function(data){$scope.ticket=data.tickets,$scope.subtickets=data.subtickets}),$scope.type={"2dx":"Cocos2d x","2djs":"Cocos2d JS","2dlua":"Cocos2d lua","2dstudio":"Cocos2d Studio","2dcode":"Cocos2d Code IDE",anysdk:"AnySDK",other:"其他"},UserCenter.process("xticket",function(user){$scope.user=user}),$scope.submitticket=function(){var content=$scope.textarea,image=$scope.image;$http.post("/subticket",{content:content,image:image,parent:tid},csrfconfig).success(function(data){console.log(data)})},$scope.tips="上传图片（可选）",document.querySelector(".imagefile").onchange=reader}),angular.module("cocos.index").controller("userinfo",function($scope,$http){function checkstatus(){var index=0;$http.get("/user").success(function(data){data&&"0"!=data.active?"1"==data.active?"/getstarted"!=location.pathname&&(location.href="/getstarted#1"):(index=data.email.indexOf("@"),$scope.userinfo=data,$scope.home="/allticket",$scope.sign_status="yes",UserCenter.userinfo=data,UserCenter.loaded()):"/"!=location.pathname&&"/register"!=location.pathname&&(location.href="/")})}var UserCenter={};UserCenter.callbacks={},$scope.home="/",$scope.sign_status="no",UserCenter.process=function(key,func){var userinfo=this.userinfo;userinfo?func(userinfo):this.callbacks[key]=func},UserCenter.loaded=function(){var key;for(key in this.callbacks)this.callbacks[key](this.userinfo)},$scope.usershow=!1,$scope.logout=function(){$http.get("/logout").success(function(){location.href="/",localStorage.email=""})},checkstatus(),setInterval(checkstatus,1e4),"/team"==location.pathname&&($scope.team="current"),"/tickets"==location.pathname&&($scope.tickets="current"),window.UserCenter=UserCenter}),angular.module("cocos.index").controller("chatController",function($scope,$http,$route,userinfo){function buffer(){index=0,$http.get("/tickets/").success(function(data){$scope.tickets=data,data.map(function(item,i){item._id==currentid&&(index=i)}),$scope.tickets[index].current=!0})}$scope.newticket=!1;var index=0,currentid=$route.current&&$route.current.params.id;userinfo.get({},function(data){$scope.userinfo=data}),$scope.showdialog=function(){$scope.newticket=!0},$scope.select=function(url){return"/chat/logout"==url?void $http.get("/logout").success(function(){location.href="/"}):"/chat/qa"==url?void(location.href="/qa.html"):"/chat/pricing"==url?void(location.href="/pricing.html"):(index&&($scope.tickets[index].current=!1),void history.pushState({},"",url))},$scope.loading=function(xindex,tid){$scope.tickets[index].current=!1,$scope.tickets[xindex].current=!0,index=xindex,history.pushState({},"","/chat/room/"+tid)},userinfo.get({},function(data){$scope.userinfo=data});var types={"2dx":"Cocos2d x","2djs":"Cocos2d JS","2dlua":"Cocos2d lua","2dstudio":"Cocos2d Studio","2dcode":"Cocos2d Code IDE",anysdk:"AnySDK",other:"其他"};$scope.selects={type:"select",data:types,show:!1,selected:types["2dx"],select:function(p){this.selected=types[p],this.show=!1}},$scope.closedialog=function(){$scope.newticket=!1},$scope.ticketform={ticket:"team"},$scope.postticket=function(){var data=$scope.ticketform;return data.type=$scope.selects.selected,0==data.title.length?alert("请添加标题"):0==data.content.length?alert("请添加内容"):void $http.post("/ticket",data,csrfconfig).success(function(data){buffer(),$scope.newticket=!1,currentid=data[0]._id,$scope.loading(index,data[0]._id)})},buffer()}),angular.module("cocos.index").controller("chatHistory",function($scope,$http,$route,userinfo,socket){function loading(){$http.get("/ticket/data/"+currentid).success(function(data){socket.emit("init",{_id:currentid}),listener(currentid),$scope.ticket=data.tickets,subtickets.innerHTML="",data.subtickets.map(render),setTimeout(reset,200)})}function listener(id){cache[id]||(socket.on("message"+id,render),cache[id]=!0)}function render(data){var dom=template.slice(0);dom=dom.replace("#{content}",data.content),dom=dom.replace("#{author}",data.author),dom=dom.replace("#{time}",data.time),dom=dom.replace("#{_id}",data.userid),"2361bdf7c55e26ed9d322476dd0563637f3a401d"==data.teamname?dom.replace("#{offical}","offical"):dom.replace("#{offical}",""),subtickets.insertAdjacentHTML("beforeend",dom),setTimeout(reset,200)}function reset(){content.scrollTop=30+content.scrollHeight-content.clientHeight}var loading,currentid=$route.current.params.id,cache={},template=document.querySelector("#template").value,content=document.querySelector(".content"),subtickets=document.querySelector(".subtickets");userinfo.get({},function(data){$scope.userinfo=data}),$scope.help=function(tid){window.confirm("确认请求官方的支持？")&&$http.post("/offical",{id:tid},csrfconfig).success(function(data){data.status?alert(data.msg):(alert("处理成功"),$scope.ticket.offical="offical")})},$scope.submit=function($event){var text,sub={};"13"==$event.keyCode&&$scope.inputtext.length&&0==$event.shiftKey&&(text=$scope.inputtext,$scope.inputtext="",sub.parent=currentid,sub.content=text,sub.author=$scope.userinfo.name,sub.userid=$scope.userinfo._id,console.log(sub),socket.emit("message",sub))},$scope.filter=function($event){var items,file,reader;return items=$event.clipboardData.items,items[0]&&"image/png"==items[0].type?(file=items[0].getAsFile(),reader=new FileReader,reader.onload=function(e){$http.post("/uploadfile",{base64:e.target.result},csrfconfig).success(function(data){var sub={};sub.parent=currentid,sub.content="![图片](/upload/"+data.id+")",sub.author=$scope.userinfo.name,sub.userid=$scope.userinfo._id,socket.emit("message",sub)})},void reader.readAsDataURL(file)):!0};var cache={};loading(),userinfo.get({},function(data){$scope.userinfo=data})}),angular.module("cocos.index").controller("homeController",function($scope,$http,userinfo){function uploadHead(file){{var reader=new FileReader,canvas=(document.querySelector(".previewfile"),document.getElementById("canvas"));canvas.getContext("2d")}reader.onloadend=function(){var base64=reader.result;$http.post("/uploadfile",{base64:base64,name:$scope.user._id},csrfconfig).success(function(){$http.post("/user",{name:$scope.user.name},csrfconfig).success(function(){alert("保存成功"),location.reload()})})},reader.readAsDataURL(file)}var input=document.querySelector("#uploadfile");userinfo.get({},function(data){$scope.user=data}),input.onchange=function(){console.log("asdasd")},$scope.post=function(){var file=input.files[0];file?uploadHead(file):$http.post("/user",{name:$scope.user.name},csrfconfig).success(function(){alert("保存成功"),location.reload()})}}),angular.module("cocos.index").controller("teamController",function($scope,$http,userinfo){$scope.users=[],userinfo.get({},function(data){$scope.user=data}),$http.get("/teamuser").success(function(data){$scope.users=data}),$scope.invite=function(){var user={};user.email1=$scope.inviteemail,$http.post("/email",user,csrfconfig).success(function(data){1==data.status?(alert(data.msg),$scope.inviteemail=""):alert("邀请成功")})}}),angular.module("cocos.index").controller("getstartedController",function($scope,$http){var h=location.hash.slice(1);$scope.email=localStorage.email,$scope.step=h?h:"1",$scope.userinfo={},$scope.emails=["email1","email2","email3"],$scope.addemail=function(){$scope.emails.push(Date.now())},$scope.invite=function(){var user=$scope.userinfo;$http.post("/email",user,csrfconfig).success(function(data){alert(1==data.status?data.msg:"邀请成功")})},$scope.submit=function(){var user=$scope.userinfo;return user.username&&user.password?user.password!=user.password2?alert("密码不一致"):void(user.username.length&&user.password==user.password2&&user.password.length&&$http.post("/user",{name:user.username,qq:user.qq,phone:user.phone,password:user.password},csrfconfig).success(function(){$scope.step="2",location.hash="#2"})):alert("请填写")},$scope.addteamname=function(){var user=$scope.userinfo;user.teamname.length?$http.post("/user",{teamname:user.teamname},csrfconfig).success(function(){$scope.step="3",location.hash="#3"}):alert("团队名为空")},$scope.submitall=function(){var user=$scope.userinfo;user.domain.length&&$http.post("/user?end=1",{domain:user.domain},csrfconfig).success(function(){$scope.step="4",location.hash="#4"})}}),angular.module("cocos.index").controller("userinitController",function($scope,$http){var h=location.hash.slice(1);$scope.email=localStorage.email,$scope.step=h?h:"1",$scope.userinfo={},$scope.submit=function(){var user=$scope.userinfo;return user.username&&user.password?user.password!=user.password2?alert("密码不一致"):void(user.username.length&&user.password==user.password2&&user.password.length&&$http.post("/user",{name:user.username,password:user.password},csrfconfig).success(function(){$scope.step="2",location.href="/allticket"})):alert("请填写")}}),cocos.factory("userinfo",function($resource){return $resource("/user")}),cocos.factory("socket",function(){var socket=io.connect("http://"+location.hostname+":8000",{transports:["websocket","polling","flashsocket"]});return socket.emit("connected"),socket});var isBind={},bind=function(key,callback){isBind[key]||(Object.defineProperty(window,key,{set:function(value){return callback(value),value}}),isBind[key]=!0)},csrfconfig={headers:{"X-Csrf-Token":document.getElementById("token").value}};cocos.config(function($routeProvider){$routeProvider.when("/chat/room/:id",{templateUrl:"/templates/chat/chathistory.html",title:"Cocos企业会员"}).when("/chat/home",{templateUrl:"/templates/chat/home.html",title:"Cocos企业会员"}).when("/chat/team",{templateUrl:"/templates/chat/team.html",title:"Cocos企业会员"}).when("/chat/qa",{templateUrl:"/templates/chat/qa.html",title:"Cocos企业会员"}).when("/register",{templateUrl:"/templates/register.html",title:"Cocos企业会员"}).when("/",{templateUrl:"/templates/intro.html",title:"Cocos企业会员介绍"}).when("/pay",{templateUrl:"/templates/pay.html",title:"Cocos企业会员"}).when("/getstarted",{templateUrl:"/templates/getstarted/userinfo.html",title:"Cocos企业会员"}).when("/inituser",{templateUrl:"/templates/getstarted/teaminfo.html",title:"Cocos企业会员"}).when("/allticket",{templateUrl:"/templates/tickets.html",title:"会员中心"}).when("/new",{templateUrl:"/templates/newticket.html",title:"新建工单"}).when("/ticket/:id",{templateUrl:"/templates/ticket.html",title:"工单"}).when("/team",{templateUrl:"/templates/team.html",title:"工单"})}),cocos.config(function($locationProvider){$locationProvider.html5Mode({enabled:!0,requireBase:!1})}).run(function($rootScope,$route,$location,$routeParams,ngProgress,navlist){$rootScope.$on("$routeChangeStart",function(){ngProgress.start()}),$rootScope.$on("$routeChangeSuccess",function(){navlist(),ngProgress.complete(),$rootScope.titleDetail="",$rootScope.title=$route.current.title,$rootScope.isCollapsed=!0,$rootScope.currentAddr=null})}),cocos.directive("a",function(){return{restrict:"E",link:function(scope,elem,attrs){(""===attrs.href||"#"===attrs.href||"logout"==attrs.href)&&elem.on("click",function(e){e.preventDefault()})}}});